<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Markdown → Mindmap (Offline‑Ready, Radial)</title>
  <link rel="icon" href="data:," />
  <style>
    :root { --bg:#0b0f14; --panel:#0f1520; --border:#1f2a37; --text:#e5e7eb; --muted:#9ca3af; --accent:#60a5fa; --node:#111827; --edge:#374151; --nodeText:#f3f4f6; }
    [data-theme="light"] { --bg:#f8fafc; --panel:#ffffff; --border:#e5e7eb; --text:#0f172a; --muted:#475569; --accent:#2563eb; --node:#f1f5f9; --edge:#94a3b8; --nodeText:#0f172a; }
    html,body{height:100%}
    body{margin:0;display:flex;flex-direction:column;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
    header{display:flex;align-items:center;gap:10px;padding:10px 14px;border-bottom:1px solid var(--border);background:var(--panel);position:sticky;top:0;z-index:10}
    header h1{font-size:14px;margin:0;font-weight:600;letter-spacing:.2px}
    .row{flex:1;min-height:0;display:grid;grid-template-columns:420px 1fr}
    .left,.right{min-width:0}
    .left{display:flex;flex-direction:column;border-right:1px solid var(--border);background:var(--panel)}
    .controls{display:flex;flex-wrap:wrap;gap:8px;padding:10px;border-bottom:1px solid var(--border)}
    .controls button,.controls select,.controls a.label{appearance:none;border:1px solid var(--border);background:transparent;color:var(--text);padding:8px 10px;border-radius:10px;cursor:pointer;font-weight:600}
    .controls button:hover,.controls select:hover{border-color:var(--accent)}
    .controls .spacer{flex:1}
    textarea{flex:1;width:100%;background:transparent;color:var(--text);border:0;outline:none;resize:none;padding:14px;font:13px/1.5 ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace}
    .right{position:relative}
    #mindmap{position:absolute;inset:0}
    .footer{padding:8px 12px;border-top:1px solid var(--border);color:var(--muted);background:var(--panel)}
    .badge{color:var(--muted);font-weight:600}
    .mm-toolbar{position:absolute;right:14px;top:14px;z-index:20}
    .status{margin-left:auto;font-size:12px;color:var(--muted)}
    .status.ok{color:#22c55e}
    .status.err{color:#ef4444}
    .status.warn{color:#f59e0b}
    .hint{font-size:12px;color:var(--muted)}
    .pill{font-size:11px;padding:2px 6px;border:1px solid var(--border);border-radius:999px}
    .legend{position:absolute;left:14px;top:14px;display:flex;gap:8px}
    @media (max-width:900px){.row{grid-template-columns:1fr}.left{border-right:0;border-bottom:1px solid var(--border)}}
  </style>
</head>
<body data-theme="dark">
  <header>
    <h1>Markdown → Mindmap</h1>
    <span class="badge">(Markmap‑style)</span>
    <span id="status" class="status">Loading…</span>
  </header>

  <div class="row">
    <section class="left">
      <div class="controls">
        <button id="btn-new">New</button>
        <button id="btn-sample">Sample</button>
        <label class="label" for="file">Import .md</label>
        <input id="file" type="file" accept=".md,.markdown,text/markdown" hidden />
        <button id="btn-copy">Copy Link</button>
        <button id="btn-svg">Export SVG</button>
        <button id="btn-png">Export PNG</button>
        <span class="spacer"></span>
        <select id="theme">
          <option value="dark" selected>Dark</option>
          <option value="light">Light</option>
        </select>
        <select id="layout">
          <option value="radial" selected>Radial</option>
          <option value="mindmap">Mindmap (L→R)</option>
        </select>
        <button id="btn-reload">Reload Libs</button>
      </div>
      <textarea id="md" placeholder="# Start typing Markdown here...\n\n- Use headings to create main nodes\n  - Sub bullets become branches\n\n> Tip: Click ‘Sample’ to load an example."></textarea>
      <div class="footer">Made with <a href="https://markmap.js.org/" target="_blank" rel="noreferrer">markmap</a> when available. Falls back to an offline renderer if CDNs are blocked. <span class="hint" id="source-hint"></span></div>
    </section>

    <section class="right">
      <div class="legend"><span id="mode-pill" class="pill">mode: loading…</span></div>
      <svg id="mindmap" role="img" aria-label="Mindmap visualization"></svg>
      <div id="toolbar" class="mm-toolbar"></div>
    </section>
  </div>

  <script>
    // ==============================
    // Utilities
    // ==============================
    const $ = (q)=>document.querySelector(q);
    const debounce = (fn,wait=250)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); } };
    const encodeHash=(text)=> '#mm='+ btoa(unescape(encodeURIComponent(text)));
    const decodeHash=()=>{ const m=location.hash.match(/^#mm=(.*)$/); if(!m) return ''; try{ return decodeURIComponent(escape(atob(m[1])));}catch{return '';} };
    const STATUS = $('#status'); const SOURCE_HINT = $('#source-hint'); const MODE_PILL = $('#mode-pill');
    function setStatus(msg, cls){ STATUS.textContent = msg; STATUS.className = 'status ' + (cls||''); }
    function setSourceHint(txt){ SOURCE_HINT.textContent = txt ? ` • source: ${txt}` : ''; }
    function setMode(m){ MODE_PILL.textContent = `mode: ${m}`; }

    // ==============================
    // CDN loader (will often be blocked in sandbox). If all fail, we go offline.
    // ==============================
    function loadScript(src){
      return new Promise((resolve,reject)=>{ const s=document.createElement('script'); s.src=src; s.async=true; s.crossOrigin='anonymous'; s.onload=()=>resolve(src); s.onerror=()=>reject(new Error('Failed to load '+src)); document.head.appendChild(s); });
    }
    function loadCSS(href){ return new Promise((resolve,reject)=>{ const l=document.createElement('link'); l.rel='stylesheet'; l.href=href; l.crossOrigin='anonymous'; l.onload=()=>resolve(href); l.onerror=()=>reject(new Error('Failed to load '+href)); document.head.appendChild(l); }); }

    async function tryUMD(){
      const a={ lib:'https://unpkg.com/markmap-lib@0.16.2/dist/browser/index.min.js', view:'https://unpkg.com/markmap-view@0.16.2/dist/index.min.js', toolbar:'https://unpkg.com/markmap-toolbar@0.16.2/dist/index.min.js', toolbarCSS:'https://unpkg.com/markmap-toolbar@0.16.2/dist/style.css'};
      const b={ lib:'https://cdn.jsdelivr.net/npm/markmap-lib@0.16.2/dist/browser/index.min.js', view:'https://cdn.jsdelivr.net/npm/markmap-view@0.16.2/dist/index.min.js', toolbar:'https://cdn.jsdelivr.net/npm/markmap-toolbar@0.16.2/dist/index.min.js', toolbarCSS:'https://cdn.jsdelivr.net/npm/markmap-toolbar@0.16.2/dist/style.css'};
      async function setCDN(c,label){ await loadScript(c.lib); await loadScript(c.view); await Promise.all([loadScript(c.toolbar), loadCSS(c.toolbarCSS).catch(()=>{})]); if(!window.markmap||!window.markmapToolbar) throw new Error('Globals missing'); setSourceHint(label+' (UMD)'); }
      try{ await setCDN(a,'unpkg'); return true; }catch(e){ console.warn('unpkg failed',e); }
      try{ await setCDN(b,'jsDelivr'); return true; }catch(e){ console.warn('jsDelivr failed',e); }
      return false;
    }

    async function initLibraries(){ setStatus('Loading libraries…'); const ok=await tryUMD(); return ok? 'markmap':'offline'; }

    // ==============================
    // Offline engine (radial + wrap + collapse + pan/zoom)
    // ==============================
    const offlineState = { collapsed: new Set(), scale: 1, offsetX: 0, offsetY: 0 };
    function nodeKeyFromPath(pathArr){ return pathArr.join(' / '); }

    function parseMarkdownBasic(md){
      const lines = md.split(/\r?\n/); const root = { text:'ROOT', children:[] };
      const stack = [{ level:0, node: root }]; const listStack = [{ indent: -1, node: root }];
      function addChild(parent, text){ const n={ text:text.trim(), children:[] }; parent.children.push(n); return n; }
      for (let raw of lines){
        const line = raw.replace(/\t/g,'    ');
        const h = line.match(/^(#{1,6})\s+(.+)$/); if (h){ const level=h[1].length, text=h[2]; while(stack.length && stack[stack.length-1].level>=level) stack.pop(); const parent=stack[stack.length-1].node; const node=addChild(parent,text); stack.push({level,node}); listStack.length=1; listStack[0]={indent:-1,node}; continue; }
        const m = line.match(/^(\s*)([-*+])\s+(.+)$/); if (m){ const indent=m[1].length, text=m[3]; while(listStack.length && listStack[listStack.length-1].indent>=indent) listStack.pop(); const parent=listStack[listStack.length-1].node; const node=addChild(parent,text); listStack.push({indent,node}); }
      }
      if (root.children.length===0){ root.children.push({ text:'Mindmap', children:[] }); }
      return root;
    }

    function renderOffline(svg, md, layoutMode){
      const parsed = parseMarkdownBasic(md); const base = (parsed.children.length===1 ? parsed.children[0] : parsed);
      function applyCollapse(node, path){ const key=nodeKeyFromPath(path); node.__key=key; node.__collapsed=offlineState.collapsed.has(key); if(node.__collapsed) return; (node.children||[]).forEach((ch,i)=>applyCollapse(ch, path.concat(ch.text||('child'+i)))); }
      applyCollapse(base, [base.text||'ROOT']);

      const NODE_W=180, NODE_H=28, LAYER_R=140, LAYER_PAD=20; const visibleChildren=(n)=> n.__collapsed?[]:(n.children||[]);
      function countLeaves(n){ const kids=visibleChildren(n); if(!kids.length) return 1; return kids.map(countLeaves).reduce((a,b)=>a+b,0); }

      let nodes=[];
      if (layoutMode==='radial'){
        const angleStart=-Math.PI/2 - Math.PI*0.8/2, angleEnd=-Math.PI/2 + Math.PI*0.8/2;
        function layoutRadial(node, depth, a0, a1){ const kids=visibleChildren(node); const r=depth*LAYER_R+LAYER_PAD; const ang=(a0+a1)/2; nodes.push({ node, x:r*Math.cos(ang), y:r*Math.sin(ang), depth, a0, a1 }); if(!kids.length) return; let acc=a0; const total=kids.map(countLeaves).reduce((s,v)=>s+v,0); kids.forEach(ch=>{ const w=countLeaves(ch)/total*(a1-a0); const aS=acc, aE=acc+w; acc=aE; layoutRadial(ch, depth+1, aS, aE); }); }
        layoutRadial(base,0,angleStart,angleEnd);
      } else {
        // simple left-to-right fallback
        let yCursor=0; function dfs(n,d){ const kids=visibleChildren(n); if(!kids.length){ const y=yCursor; yCursor+=42; nodes.push({node:n,x:d*220,y}); return; } const start=nodes.length; kids.forEach(ch=>dfs(ch,d+1)); const slice=nodes.slice(start); const y=(slice[0]?.y + slice[slice.length-1]?.y)/2 || (yCursor+=42); nodes.push({node:n,x:d*220,y}); } dfs(base,0);
      }

      const xs = nodes.map(n=>n.x), ys = nodes.map(n=>n.y);
      const minX = Math.min(...xs)-NODE_W-100, maxX = Math.max(...xs)+NODE_W+100;
      const minY = Math.min(...ys)-NODE_H-100, maxY = Math.max(...ys)+NODE_H+100;
      const width = maxX-minX, height = maxY-minY;
      svg.setAttribute('viewBox', `${minX} ${minY} ${width} ${height}`);
      svg.innerHTML='';

      const viewport = document.createElementNS('http://www.w3.org/2000/svg','g'); viewport.setAttribute('id','viewport'); svg.appendChild(viewport);
      const gEdges = document.createElementNS('http://www.w3.org/2000/svg','g'); gEdges.setAttribute('stroke','var(--edge)'); gEdges.setAttribute('fill','none'); viewport.appendChild(gEdges);
      const gNodes = document.createElementNS('http://www.w3.org/2000/svg','g'); viewport.appendChild(gNodes);

      const index = new Map(); nodes.forEach(n=>index.set(n.node,n));
      nodes.forEach(n=>{ const kids=visibleChildren(n.node); kids.forEach(ch=>{ const a=index.get(n.node), b=index.get(ch); const path=document.createElementNS('http://www.w3.org/2000/svg','path'); const mx=(a.x+b.x)/2, my=(a.y+b.y)/2; path.setAttribute('d',`M ${a.x} ${a.y} Q ${mx} ${my} ${b.x} ${b.y}`); path.setAttribute('stroke-width','2'); gEdges.appendChild(path); }); });

      function drawWrapped(group, x, y, text){ const maxChars=26; const words=(text||'').split(/\s+/); const lines=[]; let cur=''; for(const w of words){ if((cur+(cur?' ':'')+w).length>maxChars){ if(cur) lines.push(cur); cur=w; } else cur=cur?cur+' '+w:w; } if(cur) lines.push(cur); if(!lines.length) lines.push(''); const lineH=13; const total=lineH*lines.length; lines.forEach((ln,i)=>{ const t=document.createElementNS('http://www.w3.org/2000/svg','text'); t.setAttribute('x',x); t.setAttribute('y',y + (i*lineH) - total/2 + 5); t.setAttribute('fill','var(--nodeText)'); t.setAttribute('font-size','12'); t.setAttribute('font-weight','600'); t.textContent=ln; group.appendChild(t); }); return Math.max(NODE_H,total+6); }

      nodes.forEach(n=>{ const g=document.createElementNS('http://www.w3.org/2000/svg','g'); gNodes.appendChild(g); const hasKids=(n.node.children && n.node.children.length); const rect=document.createElementNS('http://www.w3.org/2000/svg','rect'); const w=NODE_W; const h=drawWrapped(g, n.x - w/2 + 10, n.y, (n.node.text||'').replace(/<[^>]+>/g,'')); rect.setAttribute('x',n.x - w/2); rect.setAttribute('y',n.y - h/2); rect.setAttribute('width',w); rect.setAttribute('height',h); rect.setAttribute('rx','8'); rect.setAttribute('ry','8'); rect.setAttribute('fill','var(--node)'); rect.setAttribute('stroke','var(--edge)'); g.insertBefore(rect,g.firstChild); if(hasKids){ const c=document.createElementNS('http://www.w3.org/2000/svg','circle'); c.setAttribute('cx', n.x + w/2 - 12); c.setAttribute('cy', n.y - h/2 + 12); c.setAttribute('r','6'); c.setAttribute('fill', n.node.__collapsed? '#ef4444' : '#22c55e'); c.setAttribute('stroke','var(--edge)'); g.appendChild(c); }
        g.addEventListener('click', (ev)=>{ if(!hasKids) return; const key=n.node.__key; if(offlineState.collapsed.has(key)) offlineState.collapsed.delete(key); else offlineState.collapsed.add(key); render(); ev.stopPropagation(); }); });

      function applyTransform(){ const v=$('#viewport'); v && v.setAttribute('transform',`translate(${offlineState.offsetX},${offlineState.offsetY}) scale(${offlineState.scale})`); }
      applyTransform();
      svg.onwheel=(e)=>{ e.preventDefault(); const factor=e.deltaY<0?1.1:0.9; const {left,top}=svg.getBoundingClientRect(); const mx=e.clientX-left-offlineState.offsetX; const my=e.clientY-top-offlineState.offsetY; offlineState.offsetX -= mx*(factor-1); offlineState.offsetY -= my*(factor-1); offlineState.scale*=factor; applyTransform(); };
      let pan=false,sx=0,sy=0,ox=0,oy=0; svg.addEventListener('pointerdown',(e)=>{ pan=true; sx=e.clientX; sy=e.clientY; ox=offlineState.offsetX; oy=offlineState.offsetY; svg.setPointerCapture(e.pointerId); }); svg.addEventListener('pointermove',(e)=>{ if(!pan) return; offlineState.offsetX = ox + (e.clientX - sx); offlineState.offsetY = oy + (e.clientY - sy); applyTransform(); }); svg.addEventListener('pointerup',()=>{ pan=false; });
    }

    // ==============================
    // App logic (Markmap when available, else offline)
    // ==============================
    let mm, transform, Toolbar;

    function render(){
      const mdEl=$('#md'); const svg=$('#mindmap'); const modeSel=$('#layout');
      const md = mdEl.value || '# Mindmap\n\nStart typing in the left panel.';
      if (window.markmap && transform && modeSel.value!=='radial'){
        try{ const { root } = transform(md); mm.setData(root); mm.fit(); history.replaceState(null,'',encodeHash(md)); setStatus('Ready ✓','ok'); setMode('markmap'); }
        catch(e){ console.error(e); setStatus('Render error','err'); }
      } else {
        try{ renderOffline(svg, md, modeSel.value); history.replaceState(null,'',encodeHash(md)); setStatus('Ready (offline) ✓','ok'); setMode('offline'); setSourceHint('offline renderer (radial)'); }
        catch(e){ console.error(e); setStatus('Offline render error','err'); }
      }
    }

    // ========== Tests ==========
    function runSelfTests(){
      const tests=[];
      if (window.markmap && window.markmapToolbar){
        tests.push({ name:'Globals available', pass: !!(window.markmap && window.markmapToolbar) });
        try{ const { root } = transform('# A\n\n- B\n  - C'); tests.push({ name:'transform() returns root', pass: !!root && Array.isArray(root.children) }); tests.push({ name:'root has children', pass:(root.children?.length||0)>0 }); } catch(e){ tests.push({ name:'transform() executes', pass:false, error:e.message }); }
      } else {
        try{ const t = parseMarkdownBasic('# A\n\n- B\n  - C'); tests.push({ name:'offline parse children', pass:(t.children?.length||0)>0 }); }catch(e){ tests.push({ name:'offline parse children', pass:false, error:e.message }); }
        try{ const t = parseMarkdownBasic('No headings\n- one\n- two'); tests.push({ name:'offline default root', pass:(t.children?.length||0)>=1 }); }catch(e){ tests.push({ name:'offline default root', pass:false, error:e.message }); }
        try{ const enc = encodeHash('# H1'); tests.push({ name:'hash prefix', pass: enc.startsWith('#mm=') }); }catch(e){ tests.push({ name:'hash prefix', pass:false, error:e.message }); }
      }
      console.table(tests);
      const allPass = tests.every(t=>t.pass); setStatus(allPass? 'Ready ✓' : 'Diagnostics warning', allPass? 'ok':'warn');
    }

    function initApp(mode){
      const svg=$('#mindmap'); const mdEl=$('#md'); const themeEl=$('#theme'); const layoutEl=$('#layout');
      $('#btn-reload').addEventListener('click', ()=>location.reload());
      $('#file').addEventListener('change', async (e)=>{ const file=e.target.files?.[0]; if(!file) return; const text=await file.text(); mdEl.value=text; render(); e.target.value=''; });
      $('#btn-new').addEventListener('click', ()=>{ mdEl.value=''; render(); });
      $('#btn-sample').addEventListener('click', ()=>{ mdEl.value=SAMPLE; render(); });
      $('#btn-copy').addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(location.href); alert('Shareable link copied.'); }catch{ alert('Failed to copy link.'); } });
      $('#btn-svg').addEventListener('click', ()=>{ const serializer=new XMLSerializer(); const svgText=serializer.serializeToString(svg); const blob=new Blob([svgText],{type:'image/svg+xml;charset=utf-8'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='mindmap.svg'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),1000); });
      $('#btn-png').addEventListener('click', ()=>{ const serializer=new XMLSerializer(); const svgText=serializer.serializeToString(svg); const img=new Image(); const svgBlob=new Blob([svgText],{type:'image/svg+xml;charset=utf-8'}); const url=URL.createObjectURL(svgBlob); img.onload=()=>{ const scale=2; const canvas=document.createElement('canvas'); canvas.width=img.width*scale; canvas.height=img.height*scale; const ctx=canvas.getContext('2d'); ctx.setTransform(scale,0,0,scale,0,0); ctx.drawImage(img,0,0); canvas.toBlob((blob)=>{ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='mindmap.png'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1000); },'image/png'); URL.revokeObjectURL(url); }; img.onerror=()=>{ alert('PNG export failed. Try SVG export instead.'); URL.revokeObjectURL(url); }; img.src=url; });
      function applyLayout(){ render(); }
      function applyTheme(){ document.body.setAttribute('data-theme', themeEl.value); render(); }
      themeEl.addEventListener('change', applyTheme); layoutEl.addEventListener('change', applyLayout); mdEl.addEventListener('input', debounce(render, 200));

      if (mode==='markmap'){
        const { Markmap } = window.markmap; ({ transform } = window.markmap); ({ Toolbar } = window.markmapToolbar);
        mm = Markmap.create(svg, { initialExpandLevel: 3 }); const toolbar = new Toolbar(); toolbar.attach(mm); $('#toolbar').append(toolbar.render()); setMode('markmap');
      } else { setMode('offline'); setSourceHint('offline renderer (radial)'); }

      const initial = decodeHash(); $('#md').value = initial || `# Mindmap\n\nType on the left. Headings become main nodes, lists become branches.`;
      applyTheme(); render(); runSelfTests(); window.addEventListener('resize', debounce(()=>{ if (mm) mm.fit(); else render(); }, 100));
    }

    const SAMPLE = `# Projek: Sistem Rangkaian Kampus\n\n## Reka Bentuk Topologi\n- Core Layer\n  - Dual core switch\n- Distribution Layer\n  - VLAN segmentation\n- Access Layer\n  - PoE for AP & CCTV\n\n## Keselamatan\n- Firewall NGFW\n- NAC (802.1X)\n- IDS/IPS\n\n## Pemantauan\n- SNMPv3\n- Syslog + SIEM\n- NetFlow\n\n## Pelaksanaan\n- Fasa 1: Audit\n- Fasa 2: Konfigurasi\n- Fasa 3: UAT & Handover`;

    (async()=>{ try{ const mode=await initLibraries(); setStatus(mode==='markmap'?'Libraries loaded':'Offline mode', mode==='markmap'?'ok':'warn'); initApp(mode); } catch(err){ console.error(err); setStatus('Initialization error','err'); setMode('offline'); setSourceHint('offline renderer (radial)'); initApp('offline'); } })();
  </script>
</body>
</html>
